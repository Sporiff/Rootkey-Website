

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en-gb" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en-gb" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Back to the Drawing Board &mdash; Rootkey 1.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Some More Windows Work" href="2018-06-02-some-more-windows-work.html" />
    <link rel="prev" title="Microsoft Teams Deployment Headaches" href="2018-07-14-microsoft-teams-deployment-headaches.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Rootkey
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../blog/index.html">My Blog</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Technology</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="2019-04-25-matrix-is-here.html">Matrix is Here</a></li>
<li class="toctree-l2"><a class="reference internal" href="2019-02-05-goodbye-guix.html">Goodbye, Guix</a></li>
<li class="toctree-l2"><a class="reference internal" href="2019-02-04-tanuki-tunes-update.html">Tanuki Tunes Update</a></li>
<li class="toctree-l2"><a class="reference internal" href="2019-01-11-baku-social-news.html">Baku Social News</a></li>
<li class="toctree-l2"><a class="reference internal" href="2018-12-22-bakusocial.html">Baku Social</a></li>
<li class="toctree-l2"><a class="reference internal" href="2018-10-25-thermy.html">Thermy</a></li>
<li class="toctree-l2"><a class="reference internal" href="2018-10-23-elementary-juno.html">Elementary OS Juno</a></li>
<li class="toctree-l2"><a class="reference internal" href="2018-10-06-apple-drink-cider.html">Apple: Drink the Cider</a></li>
<li class="toctree-l2"><a class="reference internal" href="2018-10-02-personal-matters.html">Personal Matters</a></li>
<li class="toctree-l2"><a class="reference internal" href="2018-10-01-new-site.html">New Site</a></li>
<li class="toctree-l2"><a class="reference internal" href="2018-07-27-deploying-and-controlling-google-chrome-settings-using-microsoft-intune.html">Deploying and Controlling Google Chrome Settings Using Microsoft Intune</a></li>
<li class="toctree-l2"><a class="reference internal" href="2018-07-14-microsoft-teams-deployment-headaches.html">Microsoft Teams Deployment Headaches</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Back to the Drawing Board</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#why-did-it-have-to-be-moodle">Why Did it Have to be Moodle?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#speaking-of-azure">Speaking of Azure</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="2018-06-02-some-more-windows-work.html">Some More Windows Work</a></li>
<li class="toctree-l2"><a class="reference internal" href="2018-05-20-getting-on-with-gutenberg.html">Getting on With Gutenberg</a></li>
<li class="toctree-l2"><a class="reference internal" href="2018-05-15-knit-and-perl.html">Knit and Perl</a></li>
<li class="toctree-l2"><a class="reference internal" href="2018-05-14-pgp-problems-promise-pounding-headaches.html">PGP Problems Promise Pounding Headaches</a></li>
<li class="toctree-l2"><a class="reference internal" href="2018-05-13-a-reluctant-return-to-windows.html">A Reluctant Return to Windows</a></li>
<li class="toctree-l2"><a class="reference internal" href="2018-05-10-acclimatising-to-new-tech.html">Acclimitising to New Tech</a></li>
<li class="toctree-l2"><a class="reference internal" href="2018-05-09-another-day-another-intel-fail.html">Another Day Another Intel Fail</a></li>
<li class="toctree-l2"><a class="reference internal" href="2018-05-08-uncontrolled-devices-not-even-once.html">Uncontrolled Devices: Not Even Once</a></li>
<li class="toctree-l2"><a class="reference internal" href="2018-05-08-deploying-sophos-in-a-production-environment.html">Deploying Sophos in a Production environment</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../music/index.html">Music I’ve Made</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About Me</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contact.html">Contact Me</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Rootkey</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Technology</a> &raquo;</li>
        
      <li>Back to the Drawing Board</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/tech/2018-06-16-back-to-the-drawing-board.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="back-to-the-drawing-board">
<h1>Back to the Drawing Board<a class="headerlink" href="#back-to-the-drawing-board" title="Permalink to this headline">¶</a></h1>
<p>For the past couple of weeks I’ve been trying out new things. New to me, anyway. And as you might expect,
I’m really bad at them. Let’s talk about that!</p>
<div class="section" id="why-did-it-have-to-be-moodle">
<h2>Why Did it Have to be Moodle?<a class="headerlink" href="#why-did-it-have-to-be-moodle" title="Permalink to this headline">¶</a></h2>
<p>I work in a very Microsoft-centric environment. The vast majority of our servers are Windows 2016, 2012 R2,
and a few straggling 2008 R2 boxes which just refuse to die. Possibly for this reason, we’ve never had a
GNU/Linux technician. Our head of IT is very Linux-literate, but also time-poor. When I moved from the frontline
team to the systems team, then, all the Linux responsibilities immediately fell to me.</p>
<p>Fan-fucking-tastic.</p>
<p>My first job with GNU/Linux was to automate patching for the servers and EPOS systems as they hadn’t been
patched in years. That was all simple enough, just write out a nice little cron job with logging and leave
them to it. Much less hands-on than trying to manage WSUS. But of all these servers the two most problematic
ones are definitely our CentOS boxes which power Moodle.</p>
<p>I had no experience with Moodle until this week, but I had some experience with CentOS. Enough to know that these
boxes had been set up by a monkey with absolutely no knowledge of how to partition disk space, set up Apache, or
do pretty much anything with GNU/Linux. So when it came time to upgrade Moodle, I was pretty confident that we
were going to be boned.</p>
<p>Luckily, we managed to get the upgrade on the test server finished (not without some trial and error), but much of
the way it was set up left myself and our Moodle dev scratching our heads with a “why the fuck did they do that?” kind of
confuzzlement. Hopefully, this experiment will translate well when we do the live upgrade in a few months, and then
we’ll be able to design the whole server-side from scratch and push it into Azure with proper load-balancing.</p>
</div>
<div class="section" id="speaking-of-azure">
<h2>Speaking of Azure<a class="headerlink" href="#speaking-of-azure" title="Permalink to this headline">¶</a></h2>
<p>So in <a class="reference external" href="https://rootkey.co.uk/2018/06/02/some-more-windows-work/">this post</a> I detailed some of the trouble we’ve
been having with getting devices into AAD and Intune management using an SCCM build sequence. I have a quick update
to that as well. When last we looked at it we had got devices auto-enrolling in AAD but had yet to hand authority to
Intune. When we eventually got the auto enrolment sorted (turns out you have to assign authority to the user group
in O365 admin panel, not Azure panel. Go figure) we were still having issues managing the devices in any real way.
Intune was simply saying “MDM status: see configmgr”. Hum.</p>
<p>My co-worker quickly realised that the SMSTSPostAction I’d set up was working in that it removed the CCM client from
the machine, but it wasn’t fully successful in turning off EVERY element of CCM’s authority. While you’d have thought
that uninstalling the client would take authority away, it turns out that it really just leaves it in a managed state
as though waiting for CCM to gain control again. Not ideal. With a bit of research my colleague figured out which
regkey to turn off and I started writing the new script.</p>
<p>This was a bit more involved than running a simple command line like before. First we needed to change the <code class="docutils literal notranslate"><span class="pre">SMSTSPostAction</span></code>
to call on the PowerShell script from a local directory in bypass mode. Then, as the last step, we needed to map a
drive to point to the script’s location and use another PowerShell script to copy the CCM removal script to the
<code class="docutils literal notranslate"><span class="pre">C:\Windows\Temp</span></code> directory to be executed post OSD completion. The script itself goes like this:</p>
<p>..code-block:: powershell</p>
<blockquote>
<div><p>Start-Process -FilePath ‘C:Windowsccmsetupccmsetup.exe’ -Args “/uninstall” -Wait -NoNewWindow</p>
<p># wait for exit
$CCMProcess = Get-Process ccmsetup -ErrorAction SilentlyContinue
try{</p>
<blockquote>
<div><p>$CCMProcess.WaitForExit()</p>
</div></blockquote>
<p>}catch{</p>
<p>}</p>
<p># Stop Services
Stop-Service -Name ccmsetup -Force -ErrorAction SilentlyContinue
Stop-Service -Name CcmExec -Force -ErrorAction SilentlyContinue
Stop-Service -Name smstsmgr -Force -ErrorAction SilentlyContinue
Stop-Service -Name CmRcService -Force -ErrorAction SilentlyContinue</p>
<p># wait for exit
$CCMProcess = Get-Process ccmexec -ErrorAction SilentlyContinue
try{</p>
<blockquote>
<div><p>$CCMProcess.WaitForExit()</p>
</div></blockquote>
<p>}catch{</p>
<p>}</p>
<p># Remove WMI Namespaces
Get-WmiObject -Query “SELECT * FROM __Namespace WHERE Name=’ccm’” -Namespace root | Remove-WmiObject
Get-WmiObject -Query “SELECT * FROM __Namespace WHERE Name=’sms’” -Namespace rootcimv2 | Remove-WmiObject</p>
<p># Remove Services from Registry
$MyPath = “HKLM:SYSTEMCurrentControlSetServices”
Remove-Item -Path $MyPathCCMSetup -Force -Recurse -ErrorAction SilentlyContinue
Remove-Item -Path $MyPathCcmExec -Force -Recurse -ErrorAction SilentlyContinue
Remove-Item -Path $MyPathsmstsmgr -Force -Recurse -ErrorAction SilentlyContinue
Remove-Item -Path $MyPathCmRcService -Force -Recurse -ErrorAction SilentlyContinue</p>
<p># Remove SCCM Client from Registry
$MyPath = “HKLM:SOFTWAREMicrosoft”
Remove-Item -Path $MyPathCCM -Force -Recurse -ErrorAction SilentlyContinue
Remove-Item -Path $MyPathCCMSetup -Force -Recurse -ErrorAction SilentlyContinue
Remove-Item -Path $MyPathSMS -Force -Recurse -ErrorAction SilentlyContinue</p>
<p># Remove Folders and Files
$MyPath = $env:WinDir
Remove-Item -Path $MyPathCCM -Force -Recurse -ErrorAction SilentlyContinue
Remove-Item -Path $MyPathccmsetup -Force -Recurse -ErrorAction SilentlyContinue
Remove-Item -Path $MyPathccmcache -Force -Recurse -ErrorAction SilentlyContinue
Remove-Item -Path $MyPathSMSCFG.ini -Force -ErrorAction SilentlyContinue
Remove-Item -Path $MyPathSMS*.mif -Force -ErrorAction SilentlyContinue
Remove-Item -Path $MyPathSMS*.mif -Force -ErrorAction SilentlyContinue</p>
<p>#Remove authority from CCM
$MyPath = “HKLM:SOFTWAREMicrosoft”
Remove-Item -Path $MyPathDeviceManageabilityCSP -Force -Recurse -ErrorAction SilentlyContinue&lt;/code&gt;&lt;/pre&gt;</p>
</div></blockquote>
<p>A little lengthy compared to the last one, but lo and behold Intune picked up the new machine and started applying policies. Huzzah!</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="2018-06-02-some-more-windows-work.html" class="btn btn-neutral float-right" title="Some More Windows Work" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="2018-07-14-microsoft-teams-deployment-headaches.html" class="btn btn-neutral float-left" title="Microsoft Teams Deployment Headaches" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Ciarán Ainsworth

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>